<!DOCTYPE html><html lang="en"><head><title>views/evaluation_detail.js</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="views/evaluation_detail.js"><meta name="groc-project-path" content="app/assets/javascripts/backbone/views/evaluation_detail.js.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/assets/javascripts/backbone/views/evaluation_detail.js.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p>VOCAT 3: The Phoenix Rises from the Ashes</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(c) 2013 Baruch College, CUNY
Created by Zach Davis, Cast Iron Coding
http://castironcoding.com</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetail</span> <span class="k">extends</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">AbstractView</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="initial-setup">Initial Setup</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the view's template.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">template: </span><span class="nx">HBT</span><span class="p">[</span><span class="s">&quot;backbone/templates/evaluation_detail&quot;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Assign any default values to the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">defaults: </span><span class="p">{</span>
  <span class="p">}</span>

  <span class="nv">initialize: </span><span class="nf">(options)  -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Overlay options on top of this view's defaults.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">@defaults</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Assign the current course ID to the view so that it can be incorporated into child routes. We expect the course ID
to be passed to this object throught the options. In some cases, the data for this view is bootstrapped onto the
page, in which case the course ID is generally not needed.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">courseId</span><span class="o">?</span>
      <span class="vi">@courseId = </span><span class="nx">options</span><span class="p">.</span><span class="nx">courseId</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the evaluation detail's project from the options (if we're in the course map), or from the bootstrapped data
(if we're on the creator evaluation detail view).</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="o">?</span>
      <span class="vi">@project = </span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Bootstrap</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Project</span><span class="o">?</span>
      <span class="vi">@project = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Project</span><span class="p">(</span><span class="nx">Vocat</span><span class="p">.</span><span class="nx">Bootstrap</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Project</span><span class="p">,</span> <span class="p">{</span><span class="nv">parse: </span><span class="kc">true</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Like the project, the creator model for this view can be passed in via options or bootstrapped into the page.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">creator</span><span class="o">?</span>
      <span class="vi">@creator = </span><span class="nx">options</span><span class="p">.</span><span class="nx">creator</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Bootstrap</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Creator</span><span class="o">?</span>
      <span class="vi">@creator = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Creator</span><span class="p">(</span><span class="nx">Vocat</span><span class="p">.</span><span class="nx">Bootstrap</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Creator</span><span class="p">,</span> <span class="p">{</span><span class="nv">parse: </span><span class="kc">true</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Similarly, the detail's submission can be set from options or bootstrapped data. Unlike projects and creators,
the submission will be fetched asynchronously if it's not present during view initialization. The submission is
the principal model for this view, so the rendering is defered until the submission has been loaded.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">submission</span><span class="o">?</span>
      <span class="vi">@submission = </span><span class="nx">options</span><span class="p">.</span><span class="nx">submission</span>
      <span class="nx">@submissionLoaded</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Bootstrap</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Submission</span><span class="o">?</span>
      <span class="vi">@submission = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Submission</span><span class="p">(</span><span class="nx">Vocat</span><span class="p">.</span><span class="nx">Bootstrap</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Submission</span><span class="p">,</span> <span class="p">{</span><span class="nv">parse: </span><span class="kc">true</span><span class="p">})</span>
      <span class="nx">@submissionLoaded</span><span class="p">()</span>
    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A single submission is typically fetched by project and creator ID, not by submission ID, because a submission
is created just-in-time on the backend if it does not already exist.</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@submissions = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">Submission</span><span class="p">([],</span> <span class="p">{</span>
        <span class="nv">courseId: </span><span class="nx">@courseId</span>
        <span class="nv">creatorId: </span><span class="nx">@creator</span><span class="p">.</span><span class="nx">id</span>
        <span class="nv">projectId: </span><span class="nx">@project</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">})</span>
      <span class="nx">@submissions</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
        <span class="nv">success: </span><span class="o">=&gt;</span>
          <span class="vi">@submission = </span><span class="nx">@submissions</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="nx">@submissionLoaded</span><span class="p">()</span>
      <span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The evalutation detail view needs to redraw itself to load the video once it sees that transcoding has been
completed.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s">&#39;transcodingComplete&#39;</span><span class="p">,</span> <span class="nx">@render</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Once the submission has been loaded, we can check if the submission has an attachment and, if it does, we can fetch
annotations for that attachment. We can also render the view at this point.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">submissionLoaded: </span><span class="p">()</span> <span class="nf">-&gt;</span>
    <span class="nv">options = </span><span class="p">{</span><span class="nv">attachmentId: </span><span class="nx">@submission</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;video_attachment_id&#39;</span><span class="p">)}</span>
    <span class="vi">@annotations = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">Annotation</span><span class="p">([],</span> <span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if @submission.get('video<em>attachment</em>id')
     @annotations.fetch();</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@render</span><span class="p">()</span>

  <span class="nv">render: </span><span class="p">()</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The evaluation detail view is by and large a wrapper around a handful of child views. Therefore, it doesn't need
very much information.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">context = </span><span class="p">{</span>
      <span class="nv">project: </span><span class="nx">@project</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
      <span class="nv">creator: </span><span class="nx">@creator</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render this view onto the page.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">@template</span><span class="p">(</span><span class="nx">context</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Then <code>renderChildViews</code> into the rendered evaulation detail HTML.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@renderChildViews</span><span class="p">()</span>

  <span class="nv">renderChildViews: </span><span class="p">()</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This hash forms the basis of the options passed to the child views.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">childViewOptions = </span><span class="p">{</span>
      <span class="nv">creator: </span><span class="nx">@creator</span>
      <span class="nv">project: </span><span class="nx">@project</span>
      <span class="nv">submission: </span><span class="nx">@submission</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The score view, annotations view, and the player view should always be visible.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">scoreView       = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetailScore</span><span class="p">(</span><span class="nx">childViewOptions</span><span class="p">)</span>
    <span class="nv">annotationsView = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetailAnnotations</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">childViewOptions</span><span class="p">,</span> <span class="p">{</span><span class="nv">annotations: </span><span class="nx">@annotations</span><span class="p">}))</span>
    <span class="nv">playerView      = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetailPlayer</span><span class="p">(</span><span class="nx">childViewOptions</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Our method for rendering views is to render the view's element into the parent container.
See http://stackoverflow.com/questions/11274806/backbone-render-return-this</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;[data-behavior=&quot;score-view&quot;]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">scoreView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;[data-behavior=&quot;annotations-view&quot;]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">annotationsView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;[data-behavior=&quot;player-view&quot;]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">playerView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The rest of the views are conditional, depending on user's abilities.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@submission</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;current_user_can_discuss&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span>
      <span class="nv">discussionView = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetailDiscussion</span><span class="p">(</span><span class="nx">childViewOptions</span><span class="p">)</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;[data-behavior=&quot;discussion-view&quot;]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">discussionView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">@submission</span><span class="p">.</span><span class="nx">canBeAnnotated</span><span class="p">()</span> <span class="o">==</span> <span class="kc">true</span>
      <span class="nv">annotatorView = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetailAnnotator</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">childViewOptions</span><span class="p">,</span> <span class="p">{</span><span class="nv">annotations: </span><span class="nx">@annotations</span><span class="p">}))</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;[data-behavior=&quot;annotator-view&quot;]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">annotatorView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">@submission</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;current_user_can_attach&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span>
      <span class="nv">uploadView = </span><span class="k">new</span> <span class="nx">Vocat</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">EvaluationDetailUpload</span><span class="p">(</span><span class="nx">childViewOptions</span><span class="p">)</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;[data-behavior=&quot;upload-view&quot;]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">uploadView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span></div></div></div></div></body></html>